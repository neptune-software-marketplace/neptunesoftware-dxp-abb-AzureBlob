{
	"id": "9892e8d9-476b-ed11-9f60-000d3aba46be",
	"createdAt": "2022-11-23T15:59:56.376Z",
	"createdBy": "carlos.pires@neptune-software.com",
	"globalScripts": [
		{
			"id": "7F7B8550-466B-ED11-9F60-000D3ABA46BE",
			"name": "AzureBlob - Upload",
			"contextname": "Upload"
		},
		{
			"id": "42D141DC-4E6B-ED11-9F60-000D3ABA46BE",
			"name": "AzureBlob - AllowedFileTypes",
			"contextname": "AllowedFileTypes"
		}
	],
	"externalModules": [],
	"entitySets": [],
	"apis": [],
	"name": "PrepareUpload",
	"ver": "22.11.25.1417",
	"description": null,
	"content": [
		"==OBJECT STRING==",
		"const azureblob = globals.Upload;",
		"const allowedFileTypes = globals.AllowedFileTypes;",
		"const data = req.body;",
		"",
		"",
		"const blobData = {",
		"    \"account\": \"\", //please add here your Azure blob account name",
		"    \"container\": \"\", //please add here your Azure blob container name",
		"    \"accountKey\": \"\", //please add here your Azure blob access account key ",
		"    \"blobName\": \"\",",
		"    \"contentType\": \"\",",
		"    \"metadata\": { user: req.user.username }, // in this case we are saving the user name, but can be any information ",
		"    \"buffer\": {}",
		"}",
		"",
		"",
		"const url = `https://${blobData.account}.blob.core.windows.net/${blobData.container}/`",
		"",
		"try {",
		"    let matchesBlobImg = data.base64.match(/^data:([A-Za-z-+\\/]+)\\/([A-Za-z-+\\/]+);base64,(.+)$/);",
		"    blobData.blobName = data.folder + data.name;",
		"",
		"    blobData.buffer = new Buffer.from(matchesBlobImg[3], 'base64');",
		"    blobData.contentType = matchesBlobImg[1] + \"/\" + matchesBlobImg[2];",
		"",
		"    if (allowedFileTypes.check(blobData.buffer)) {",
		"        const a = await azureblob.uploadBlob(blobData);",
		"        result.data = {",
		"            msg: \"File Uploaded!!\",",
		"            file: {",
		"                \"fileName\": data.name,",
		"                \"filePath\": blobData.blobName,",
		"                \"url\": url + blobData.blobName,",
		"                \"metadata\": blobData.metadata,",
		"                \"DateTime\": \"\",",
		"                \"contentLength\": 0",
		"            }",
		"        }",
		"",
		"    } else {",
		"        result.statusCode = 500;",
		"        result.data = {",
		"            msg: \"Only upload of images is allowed!!\"",
		"        }",
		"    }",
		"",
		"} catch (e) {",
		"    log.error(\"App Screenshot Blob error: \" + e);",
		"    result.statusCode = 500;",
		"    result.data = {",
		"        msg: \"Error saving to blob\"",
		"    };",
		"",
		"};",
		"complete();"
	],
	"useAsGlobalScript": false,
	"isTypescript": false,
	"transpiledContent": null,
	"lastRunSuccessful": false,
	"jsscriptGroup": "910f112a-466b-ed11-9f60-000d3aba46be",
	"package": "a83ed26f-446b-ed11-9f60-000d3aba46be"
}